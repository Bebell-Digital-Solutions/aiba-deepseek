<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIBAD - Asistente de Negocios con IA, impulsado por DeepSeek</title>
  
  <!-- Preconnect to CDNs for faster loading -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Required Libraries -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/react-markdown@8.0.7/dist/react-markdown.min.js"></script>
  <script src="https://unpkg.com/remark-gfm@3.0.1/dist/remark-gfm.min.js"></script>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  
  <!-- Add Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/lucide@latest/font/lucide.css">
  
  <!-- Favicon -->
  <link rel="icon" href="https://bucket.mlcdn.com/a/3336/3336910/images/d7589a2b7ec7033c2395042f615b8c5d96cc06af.png">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'brand-pink': '#DF1783',
          },
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
          }
        }
      }
    }
  </script>
  
  <style>
    .custom-image-widget {
      position: fixed !important;
      top: 50px !important;
      margin: 0 !important;
      padding: 0 !important;
      right: 0px;
      z-index: 999;
    }
    
    .custom-image {
      width: 70px;
      height: auto;
      transition: transform 0.2s;
    }
    
    .custom-image-widget:hover .custom-image {
      transform: scale(1.05);
    }  

    body {
      font-family: 'Poppins', sans-serif;
    }
    @keyframes loading-anim {
      0% { background-position: -800px 0; }
      100% { background-position: 800px 0; }
    }
    .loading-bar-anim {
      background: linear-gradient(to right, #DF1783, #e2e8f0, #DF1783);
      background-size: 800px 100%;
      animation: loading-anim 3s linear infinite;
    }
    .dark .loading-bar-anim {
      background: linear-gradient(to right, #DF1783, #1f2937, #DF1783);
      background-size: 800px 100%;
      animation: loading-anim 3s linear infinite;
    }
     .markdown-content {
        display: block !important;
  opacity: 1 !important;
  visibility: visible !important;
      line-height: 1.75;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .markdown-content > * + * {
      margin-top: 1.25rem;
    }

    .markdown-content br {
      display: block;
      content: "";
      margin-bottom: 0.75em;
    }
    
    .markdown-content p {
      margin-bottom: 1.25em;
    }
    
    .markdown-content pre {
      position: relative;
      padding-top: 2.5rem;
      margin: 1.5em 0;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
      background: #f8f8f8;
      border-left: 4px solid #DF1783;
    }

    .markdown-content pre:before {
      content: '';
      position: absolute;
      top: 0.75rem;
      left: 1rem;
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      background: #DF1783;
      box-shadow: 1.25rem 0 0 #DF1783, 2.5rem 0 0 #DF1783;
    }

    .markdown-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1em 0;
    }
    
    .dark .markdown-content pre {
      background: #1e293b;
    }
    
    .markdown-content code {
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.9em;
    }
    
    .markdown-content h1, 
    .markdown-content h2, 
    .markdown-content h3, 
    .markdown-content h4 {
      margin-top: 1.5em;
      margin-bottom: 0.75em;
      font-weight: 700;
      color: inherit;
    }
    
    /* Lists */
    .markdown-content ul,
    .markdown-content ol {
      padding-left: 1.5rem;
      margin-bottom: 1em;
    }
    
    .markdown-content li {
      margin-bottom: 0.5em;
    }
    
    .markdown-content blockquote {
      background: rgba(223, 23, 131, 0.05);
      padding: 1rem;
      border-radius: 0.375rem;
      border-left: 4px solid #DF1783;
      padding-left: 1rem;
      margin: 1.5rem 0;
      font-style: italic;
      color: #4b5563;
    }
    
    .dark .markdown-content blockquote {
      color: #9ca3af;
    }
    
    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.5rem 0;
    }
    
    .markdown-content th {
      background-color: #f3f4f6;
      font-weight: 600;
    }
    
    .markdown-content td, 
    .markdown-content th {
      border: 1px solid #e5e7eb;
      padding: 0.5rem 1rem;
    }
    
    .dark .markdown-content th {
      background-color: #374151;
    }

    /* Custom bullet points */
    .markdown-content ul {
      list-style-type: none;
      padding-left: 0;
      margin: 1em 0;
    }

    .markdown-content ul li {
      position: relative;
      padding-left: 1.5em;
      margin-bottom: 0.5em;
    }

    .markdown-content ul li:before {
      content: "â€¢";
      color: #DF1783;
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .markdown-content strong {
      font-weight: 600;
      color: inherit;
    }

    .markdown-content em {
      font-style: italic;
    }

   /* Add these to your styles */
.markdown-list {
  list-style-type: none;
  padding-left: 0;
  margin: 1em 0;
}

.markdown-list-item {
  position: relative;
  padding-left: 1.5em;
  margin-bottom: 0.5em;
}

.markdown-list-item:before {
  content: "â€¢";
  color: #DF1783;
  position: absolute;
  left: 0;
  font-weight: bold;
}

    
    .suggestion-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .emoji {
      font-size: 1.2em;
      margin-right: 4px;
    }

    .suggestion-text {
      margin: 0;
      display: inline;
    }

    .suggestion-item br {
      display: block;
      content: "";
      margin-top: 4px;
    } 
  </style>
</head>

<body class="font-sans bg-white dark:bg-gray-900 transition-colors duration-300">
  <div class="custom-image-widget" style="position: relative; display: inline-block;">
    <a href="https://bebell-digital-solutions.github.io/aiba-deepseek">
        <img class="custom-image" 
             src="https://bucket.mlcdn.com/a/3336/3336910/images/2891bb0a192c808fe1bb53e3905fc787957c2085.png" 
             alt="TraducciÃ³n al InglÃ©s"
             style="display: block;">
    </a>
  </div>
  
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    // Safety checks first
    if (typeof ReactMarkdown === 'undefined') {
      window.ReactMarkdown = ({ children }) => <div>{children}</div>;
      console.warn("ReactMarkdown no cargado - usando alternativa");
    }
    if (typeof remarkGfm === 'undefined') {
      window.remarkGfm = { default: null };
      console.warn("remarkGfm no cargado - caracterÃ­sticas de markdown limitadas");
    }

    const { useState, useEffect, useRef, useCallback } = React;
    
    // Unique ID generator
    const generateId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;   
    
    // Constants
    const MessageSender = {
      USER: 'user',
      BOT: 'bot',
    };

    const SUGGESTIONS = [
      { text: "ðŸŽ¯ Esboza una estrategia de marketing digital para una nueva tienda en lÃ­nea.", icon: "store" },
      { text: "ðŸŽ¯ Â¿CuÃ¡les son los elementos clave de una pÃ¡gina de destino exitosa para SaaS?", icon: "web" },
      { text: "ðŸŽ¯ Genera 5 ideas de publicaciones para una agencia de marketing de contenidos.", icon: "lightbulb_outline" },
      { text: "ðŸŽ¯ Explica las mejores prÃ¡cticas de SEO para un sitio web de pequeÃ±a empresa en 2025.", icon: "trending_up" },
      { text: "ðŸŽ¯ Â¿CÃ³mo puedo construir un negocio de Print-On-Demand en 2025?", icon: "apparel" },
      { text: "ðŸŽ¯ Â¿CÃ³mo puedo generar ingresos adicionales con un canal de YouTube en 2025?", icon: "youtube_activity" },
      { text: "ðŸŽ¯ Dame 5 ideas de negocios con poca o ninguna inversiÃ³n que pueda lanzar en los prÃ³ximos 5-10 dÃ­as.", icon: "rocket_launch" },
      { text: "ðŸŽ¯ Â¿CÃ³mo puedo implementar tecnologÃ­as de IA en mi prÃ¡ctica o negocio?", icon: "network_intel_node" },
    ];

    const MASTER_PROMPT = `Eres AIBAD que significa Asistente de Negocios con IA impulsado por DeepSeek, un asistente experto en desarrollo de negocios en lÃ­nea.
    Tu objetivo es proporcionar consejos prÃ¡cticos, estrategias e ideas para emprendedores y negocios que buscan crecer en lÃ­nea.
    Tus respuestas deben ser prÃ¡cticas, claras y bien estructuradas usando markdown cuando sea necesario. Antes de hacerlo, haz preguntas de manera conversacional hasta que estÃ©s 95% seguro de que puedes proporcionar una respuesta valiosa y compartir recomendaciones profesionales y accionables.
    
    
    `;
    
    const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';
    const DEEPSEEK_MODEL = 'deepseek-chat';

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error("Error capturado:", error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="flex items-center justify-center h-screen bg-white dark:bg-gray-900">
              <div className="text-center p-8 max-w-md">
                <h2 className="text-2xl font-bold text-red-500 mb-4">Algo saliÃ³ mal</h2>
                <p className="text-gray-700 dark:text-gray-300 mb-6">{this.state.error.message}</p>
                <button
                  onClick={() => window.location.reload()}
                  className="px-6 py-2 bg-brand-pink text-white rounded-full font-medium hover:opacity-90"
                >
                  Recargar PÃ¡gina
                </button>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }
    
    // Components
    const BotIcon = () => (
      <svg 
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        className="w-6 h-6 text-brand-pink"
      >
        <path d="M12 8V4H8"/>
        <rect width="16" height="12" x="4" y="8" rx="2"/>
        <path d="M2 14h2"/>
        <path d="M20 14h2"/>
        <path d="M15 13v2"/>
        <path d="M9 13v2"/>
      </svg>
    );

    const UserIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 text-gray-500 dark:text-gray-400">
        <path fillRule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clipRule="evenodd" />
      </svg>
    );

    const LoadingIndicator = () => (
      <div className="flex flex-col gap-2 w-full">
        <div className="loading-bar-anim h-3 rounded-sm w-full"></div>
        <div className="loading-bar-anim h-3 rounded-sm w-4/5"></div>
        <div className="loading-bar-anim h-3 rounded-sm w-3/5"></div>
      </div>
    );
    
    const IconButton = ({ onClick, icon, label, disabled = false, className = '' }) => (
      <button
        type="button"
        onClick={onClick}
        aria-label={label}
        disabled={disabled}
        className={`w-14 h-14 flex-shrink-0 flex items-center justify-center rounded-full bg-slate-100 dark:bg-gray-800 hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-300 disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
      >
        <span className="material-symbols-rounded text-2xl">{icon}</span>
      </button>
    );

    // Updated ApiKeyModal with name field
    const ApiKeyModal = ({ onSave, onDelete, onClose, currentKey }) => {
      const [key, setKey] = useState(currentKey || '');
      const [name, setName] = useState(() => localStorage.getItem('user-name') || '');
      const [error, setError] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!key.trim()) {
          setError('Se requiere una clave API');
          return;
        }
        onSave(key.trim(), name.trim());
      };

      const handleDelete = () => {
        onDelete();
        setKey('');
        setName('');
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg">
            <header className="p-5 border-b border-slate-200 dark:border-gray-700 flex justify-between items-center">
              <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">Administrar clave API de DeepSeek</h2>
              {currentKey && (
                <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-gray-700">
                  <span className="material-symbols-rounded text-gray-600 dark:text-gray-300">close</span>
                </button>
              )}
            </header>
            
            <form onSubmit={handleSubmit}>
              <div className="p-6 space-y-4">
                <p className="text-gray-600 dark:text-gray-400"><strong>Nota:</strong> Tu clave API y nombre se almacenan localmente en tu navegador.</p>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Clave API*</label>
                  <input 
                    type="password" 
                    value={key} 
                    onChange={e => {
                      setKey(e.target.value);
                      setError('');
                    }} 
                    placeholder="Pega tu clave API aquÃ­" 
                    className="w-full h-12 px-4 rounded-lg bg-slate-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-pink" 
                    required
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tu Nombre (Opcional)</label>
                  <input 
                    type="text" 
                    value={name} 
                    onChange={e => setName(e.target.value)} 
                    placeholder="Ingresa tu nombre" 
                    className="w-full h-12 px-4 rounded-lg bg-slate-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-pink" 
                  />
                </div>
                
                {error && <p className="mt-2 text-red-500 text-sm">{error}</p>}
                <div className="text-sm text-gray-500 dark:text-gray-400">
                  <a href="https://platform.deepseek.com/api-keys" target="_blank" rel="noopener noreferrer" className="text-brand-pink hover:underline">ObtÃ©n tu clave API</a>
                </div>
              </div>
              
              <footer className="px-6 py-4 bg-slate-50 dark:bg-gray-800/50 border-t border-slate-200 dark:border-gray-700 flex justify-between items-center">
                {currentKey ? (
                  <button type="button" onClick={handleDelete} className="px-4 py-2 text-sm bg-red-600/10 text-red-600 dark:text-red-400 rounded-full font-semibold hover:bg-red-600/20 transition-colors">Eliminar Clave</button>
                ) : <div></div>}
                <button type="submit" className="px-6 py-2.5 bg-brand-pink text-white rounded-full font-semibold hover:opacity-90 transition-opacity">
                  {currentKey ? 'Guardar Cambios' : 'Guardar y Comenzar'}
                </button>
              </footer>
            </form>
          </div>
        </div>
      );
    };

    
    
    // ChatMessage component
  const ChatMessage = ({ message }) => {
  const [copyIcon, setCopyIcon] = useState('content_copy');
  const isBot = message.sender === MessageSender.BOT;
  const isLoading = isBot && message.text === '' && !message.isError;
  const userName = localStorage.getItem('user-name') || 'You';

  const handleCopy = () => {
    if (message.text) {
      navigator.clipboard.writeText(message.text);
      setCopyIcon('done');
      setTimeout(() => setCopyIcon('content_copy'), 1500);
    }
  };

  const cleanText = (text) => {
    return text
      .replace(/^#+\s*/gm, '')    // Remove headings
      .replace(/\*\*/g, '')        // Remove bold
      .replace(/\*/g, '')          // Remove italics and list markers
      .replace(/-\s/g, 'â€¢ ')       // Replace dashes with bullets
      .replace(/^\s*>\s*/gm, '');  // Remove blockquotes
  };

  const messageContentClass = message.isError ? 'text-red-500' : 'text-gray-800 dark:text-gray-200';

  return (
    <div className="group mb-6">
      <div className="flex items-start gap-4 max-w-4xl mx-auto">
        <div className="w-10 h-10 flex-shrink-0 rounded-full flex items-center justify-center bg-slate-100 dark:bg-gray-800">
          {isBot ? <BotIcon /> : <UserIcon />}
        </div>
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-1">
            <span className="font-medium text-gray-700 dark:text-gray-300">
              {isBot ? "Bot" : userName}
            </span>
          </div>
          
          {isLoading ? (
            <LoadingIndicator />
          ) : (
            <div className={`markdown-content ${messageContentClass}`}>
              <ReactMarkdown 
                remarkPlugins={[remarkGfm.default]}
                components={{
                  // Convert all headings to paragraphs
                  h1: ({node, ...props}) => <p className="text-xl font-bold mt-6 mb-3" {...props} />,
                  h2: ({node, ...props}) => <p className="text-lg font-semibold mt-4 mb-2" {...props} />,
                  h3: ({node, ...props}) => <p className="font-medium mt-3 mb-1" {...props} />,
                  
                  // Preserve these formats:
                  p: ({node, ...props}) => <p className="my-3 leading-relaxed" {...props} />,
                  ul: ({node, ...props}) => <ul className="list-disc pl-5 space-y-1 my-3" {...props} />,
                  ol: ({node, ...props}) => <ol className="list-decimal pl-5 space-y-1 my-3" {...props} />,
                  li: ({node, ...props}) => <li className="pl-2" {...props} />,
                  br: ({node, ...props}) => <br {...props} />,
                  hr: ({node, ...props}) => <hr className="my-4 border-t border-gray-200 dark:border-gray-700" {...props} />,
                  a: ({node, ...props}) => <a className="text-brand-pink hover:underline" {...props} />
                }}
              >
                {cleanText(message.text)}
              </ReactMarkdown>
            </div>
          )}
        </div>
        {isBot && !isLoading && !message.isError && (
          <button 
            onClick={handleCopy} 
            className="opacity-0 group-hover:opacity-100 transition-opacity p-2 rounded-full hover:bg-slate-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400"
          >
            <span className="material-symbols-rounded text-lg">{copyIcon}</span>
          </button>
        )}
      </div>
    </div>
  );
};



    

    // ChatView component
    const ChatView = ({ messages }) => {
      const chatEndRef = useRef(null);
      
      useEffect(() => {
        chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      return (
        <div className="flex-1 overflow-y-auto px-4 pt-4 pb-36 sm:pb-32">
          <div className="max-w-4xl mx-auto">
            {messages.map(msg => <ChatMessage key={msg.id} message={msg} />)}
            <div ref={chatEndRef} />
          </div>
        </div>
      );
    };

    // SuggestionCard component
    const SuggestionCard = ({ text, icon, onClick }) => (
      <div onClick={onClick} className="group cursor-pointer p-5 flex-shrink-0 w-56 h-56 flex flex-col justify-between rounded-2xl bg-slate-100 dark:bg-gray-800 hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors duration-200">
        <h4 className="text-base font-medium text-gray-800 dark:text-gray-200">{text}</h4>
        <div className="self-end w-11 h-11 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-300 via-gray-200 to-gray-400 shadow-[inset_0_2px_4px_rgba(255,255,255,0.7),inset_0_-2px_4px_rgba(0,0,0,0.1)] dark:bg-gradient-to-br dark:from-gray-600 dark:via-gray-700 dark:to-gray-800 dark:shadow-[inset_0_2px_4px_rgba(0,0,0,0.3),inset_0_-2px_4px_rgba(255,255,255,0.1)] transition-all duration-300 group-hover:bg-gradient-to-tr group-hover:from-[#df1783] group-hover:to-[#fd5d93] group-hover:shadow-none">
          <span className="material-symbols-rounded text-2xl text-transparent bg-clip-text bg-gradient-to-br from-gray-600 to-gray-800 dark:from-gray-200 dark:to-gray-400 group-hover:text-white group-hover:bg-none">
            {icon}
          </span>
        </div>
      </div>
    );

    // Header component
    const Header = ({ onSuggestionClick, userName }) => {
      return (
        <header className={'flex-1 overflow-y-auto px-4 pt-16 pb-8 sm:pt-24 lg:pt-28'}>
          <div className="max-w-4xl mx-auto">
            <div>
              <h1 className="text-5xl sm:text-6xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-brand-pink to-purple-500">
                {userName ? `Hola, ${userName}` : 'Hola'}
              </h1>
              <p className="text-4xl sm:text-5xl font-medium text-gray-400 dark:text-gray-500 mt-2">Â¿CÃ³mo puedo ayudarte hoy?</p>
            </div>
            <div className="mt-16 sm:mt-24">
              <div className="flex gap-5 pb-4 -mx-4 px-4 overflow-x-auto">
                {SUGGESTIONS.map((s, i) => (
                  <SuggestionCard 
                    key={i} 
                    text={s.text} 
                    icon={s.icon} 
                    onClick={() => onSuggestionClick(s.text)} 
                  />
                ))}
              </div>
            </div>
          </div>
        </header>
      );
    };

    // FileUploadModal component
    const FileUploadModal = ({ uploadedFiles, setUploadedFiles, onClose }) => {
      const [error, setError] = useState(null);
      const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB

      const handleFileChange = useCallback(e => {
        const files = e.target.files;
        if (!files) return;
        setError(null);
        
        const validFiles = Array.from(files).filter(file => {
          if (file.size > MAX_FILE_SIZE) {
            setError(`El archivo "${file.name}" es demasiado grande (mÃ¡ximo 5MB).`);
            return false;
          }
          return true;
        });

        validFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            if(event.target?.result) {
              setUploadedFiles(prev => [...prev.filter(f => f.name !== file.name), { 
                name: file.name, 
                content: event.target.result 
              }]);
            }
          };
          reader.onerror = () => setError(`Error al leer el archivo "${file.name}".`);
          reader.readAsText(file);
        });
      }, [setUploadedFiles]);
      
      const removeFile = fileName => {
        setUploadedFiles(prev => prev.filter(f => f.name !== fileName));
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <header className="p-5 border-b border-slate-200 dark:border-gray-700 flex justify-between items-center">
              <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">Subir Archivos para Contexto</h2>
              <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-gray-700">
                <span className="material-symbols-rounded text-gray-600 dark:text-gray-300">close</span>
              </button>
            </header>
            <div className="p-6 flex-1 overflow-y-auto">
              <div className="relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center">
                <span className="material-symbols-rounded text-5xl text-gray-400 dark:text-gray-500">cloud_upload</span>
                <p className="mt-2 text-gray-600 dark:text-gray-300">Arrastra y suelta archivos aquÃ­, o haz clic para seleccionar</p>
                <input 
                  type="file" 
                  multiple 
                  onChange={handleFileChange} 
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                  accept=".txt,.md,.json,.csv,.html,.js,.ts" 
                />
              </div>
              {error && <p className="mt-4 text-center text-red-500">{error}</p>}
              <div className="mt-6">
                <h3 className="text-lg font-medium text-gray-700 dark:text-gray-200">Archivos Subidos ({uploadedFiles.length})</h3>
                {uploadedFiles.length > 0 ? (
                  <ul className="mt-3 space-y-2">
                    {uploadedFiles.map(file => (
                      <li key={file.name} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-gray-700 rounded-lg">
                        <div className="flex items-center gap-3 overflow-hidden">
                          <span className="material-symbols-rounded text-gray-500">description</span>
                          <span className="truncate text-sm text-gray-700 dark:text-gray-200">{file.name}</span>
                        </div>
                        <button 
                          onClick={(e) => {
                            e.stopPropagation();
                            removeFile(file.name);
                          }} 
                          className="p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500"
                        >
                          <span className="material-symbols-rounded text-lg">delete</span>
                        </button>
                      </li>
                    ))}
                  </ul>
                ) : (
                  <p className="mt-3 text-sm text-gray-500 dark:text-gray-400">No hay archivos subidos aÃºn.</p>
                )}
              </div>
            </div>
            <footer className="p-5 border-t border-slate-200 dark:border-gray-700 text-right">
              <button 
                onClick={onClose} 
                className="px-6 py-2.5 bg-brand-pink text-white rounded-full font-semibold hover:opacity-90 transition-opacity"
              >
                Listo
              </button>
            </footer>
          </div>
        </div>
      );
    };

    // ConversationsModal component
    const ConversationsModal = ({ conversations, onSelectConversation, onClose, onDeleteConversation }) => {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <header className="p-5 border-b border-slate-200 dark:border-gray-700 flex justify-between items-center">
              <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">Conversaciones Guardadas</h2>
              <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-gray-700">
                <span className="material-symbols-rounded text-gray-600 dark:text-gray-300">close</span>
              </button>
            </header>
            
            <div className="p-6 flex-1 overflow-y-auto">
              {conversations.length > 0 ? (
                <ul className="space-y-3">
                  {conversations.map((conversation, index) => (
                    <li key={conversation.id} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-gray-700 rounded-lg">
                      <button 
                        onClick={() => onSelectConversation(conversation)}
                        className="flex-1 text-left text-gray-700 dark:text-gray-200 hover:text-brand-pink"
                      >
                        ConversaciÃ³n {index + 1} - {new Date(conversation.timestamp).toLocaleString()}
                      </button>
                      <button 
                        onClick={() => onDeleteConversation(conversation.id)}
                        className="p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500 ml-2"
                      >
                        <span className="material-symbols-rounded text-lg">delete</span>
                      </button>
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-center text-gray-500 dark:text-gray-400">No hay conversaciones guardadas aÃºn.</p>
              )}
            </div>
            
            <footer className="p-5 border-t border-slate-200 dark:border-gray-700 text-right">
              <button 
                onClick={onClose} 
                className="px-6 py-2.5 bg-brand-pink text-white rounded-full font-semibold hover:opacity-90 transition-opacity"
              >
                Cerrar
              </button>
            </footer>
          </div>
        </div>
      );
    };

    // TypingArea component with updated features
    const TypingArea = ({ onSendMessage, isLoading, theme, toggleTheme, onDeleteChat, onOpenUploadModal, onOpenApiKeyModal, onOpenConversationsModal, isApiConfigured, uploadedFilesCount, inputValue, setInputValue }) => {
      const handleSubmit = (e) => {
        e.preventDefault();
        if (inputValue.trim() && isApiConfigured) {
          onSendMessage(inputValue);
          setInputValue('');
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          handleSubmit(e);
        }
      };

      return (
        <div className="fixed bottom-0 left-0 w-full bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg border-t border-slate-200 dark:border-gray-700">
          <div className="max-w-4xl mx-auto px-4 pt-2 pb-4 sm:pb-4">
            {uploadedFilesCount > 0 && isApiConfigured && (
              <div className="flex justify-center mb-2">
                <button 
                  onClick={onOpenUploadModal} 
                  className="flex items-center gap-2 px-3 py-1.5 text-xs sm:text-sm bg-slate-100 dark:bg-gray-800 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-colors"
                  aria-label={`Ver ${uploadedFilesCount} archivos adjuntos`}
                >
                  <span className="material-symbols-rounded text-base">attachment</span>
                  <span>{uploadedFilesCount} archivo{uploadedFilesCount > 1 ? 's' : ''} en contexto</span>
                </button>
              </div>
            )}
            <div className="flex items-center gap-3">
              <IconButton 
                onClick={onOpenApiKeyModal} 
                icon="key" 
                label="Administrar clave API" 
                className="hidden sm:flex" 
              />
              <IconButton 
                onClick={onOpenConversationsModal} 
                icon="folder" 
                label="Conversaciones guardadas" 
                className="hidden sm:flex" 
              />
              
              <form onSubmit={handleSubmit} className="flex-1 relative">
                <textarea
                  value={inputValue}
                  onChange={e => setInputValue(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder={isApiConfigured ? "Ingresa un mensaje aquÃ­..." : "Por favor configura tu clave API para comenzar."}
                  required
                  disabled={isLoading || !isApiConfigured}
                  className="w-full h-14 min-h-[56px] max-h-32 pl-6 pr-16 py-4 rounded-full bg-slate-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-pink transition disabled:opacity-70 disabled:cursor-not-allowed resize-none flex items-center"
                  rows={1}
                  style={{ lineHeight: '24px' }}
                />
                
                <button
                  type="submit"
                  disabled={isLoading || !isApiConfigured || !inputValue.trim()}
                  className={`absolute right-0 top-0 h-14 w-14 flex items-center justify-center text-white rounded-full transition-transform transform ${inputValue.trim() && isApiConfigured ? 'scale-100' : 'scale-0'} ${isLoading ? 'bg-gray-500' : 'bg-brand-pink'} disabled:bg-gray-500`}
                  aria-label="Enviar Mensaje"
                >
                  <span className="material-symbols-rounded">send</span>
                </button>
              </form>
              <div className="hidden sm:flex items-center gap-3">
                <IconButton 
                  onClick={onOpenUploadModal} 
                  icon="upload_file" 
                  label="Subir archivos" 
                  disabled={isLoading || !isApiConfigured} 
                />
                <IconButton 
                  onClick={toggleTheme} 
                  icon={theme === 'dark' ? 'light_mode' : 'dark_mode'} 
                  label="Cambiar tema" 
                />
                <IconButton 
                  onClick={onDeleteChat} 
                  icon="delete" 
                  label="Eliminar chat" 
                  disabled={isLoading || !isApiConfigured} 
                />
              </div>
              <div className="sm:hidden flex">
                <IconButton 
                  onClick={onOpenApiKeyModal} 
                  icon="key" 
                  label="Administrar clave API" 
                />
              </div>
            </div>
            <p className="hidden sm:block text-center text-xs text-gray-400 dark:text-gray-500 mt-3 px-4">
              AIBAD puede mostrar informaciÃ³n inexacta. Siempre verifica sus respuestas.
            </p>
          </div>
        </div>
      );
    };

    // Main App Component with all new features
    const App = () => {
      const [theme, setTheme] = useState(() => {
        const savedTheme = localStorage.getItem("mega-bot-theme");
        return savedTheme === 'light' || savedTheme === 'dark' 
          ? savedTheme 
          : window.matchMedia?.('(prefers-color-scheme: dark)').matches 
            ? 'dark' 
            : 'light';
      });
      
      const [messages, setMessages] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [isFileModalOpen, setFileModalOpen] = useState(false);
      const [uploadedFiles, setUploadedFiles] = useState([]);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('deepseek-api-key') || null);
      const [userName, setUserName] = useState(() => localStorage.getItem('user-name') || null);
      const [showApiKeyModal, setShowApiKeyModal] = useState(!apiKey);
      const [showConversationsModal, setShowConversationsModal] = useState(false);
      const [conversations, setConversations] = useState(() => {
        const saved = localStorage.getItem('aibad-conversations');
        return saved ? JSON.parse(saved) : [];
      });
      const [initError, setInitError] = useState(null);
      const [inputValue, setInputValue] = useState('');

      useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('mega-bot-theme', theme);
      }, [theme]);

      // Save conversations to localStorage when they change
      useEffect(() => {
        localStorage.setItem('aibad-conversations', JSON.stringify(conversations));
      }, [conversations]);

      const toggleTheme = useCallback(() => {
        setTheme(prev => prev === 'dark' ? 'light' : 'dark');
      }, []);

      const handleSaveApiKey = useCallback((key, name = '') => {
        try {
          localStorage.setItem('deepseek-api-key', key);
          if (name) {
            localStorage.setItem('user-name', name);
            setUserName(name);
          } else {
            localStorage.removeItem('user-name');
            setUserName(null);
          }
          setApiKey(key);
          setShowApiKeyModal(false);
          setInitError(null);
          
          if (messages.length === 0) {
            setMessages([{
              id: 'bot-welcome',
              sender: 'bot',
              text: name 
                ? `Â¡Hola ${name}! Soy AIBAD, tu Asistente de Negocios con IA. Â¿CÃ³mo puedo ayudarte hoy?`
                : "Â¡Hola! Soy AIBAD, tu Asistente de Negocios con IA. Â¿CÃ³mo puedo ayudarte hoy?",
              isError: false
            }]);
          }
        } catch (e) {
          console.error("Error al guardar configuraciÃ³n:", e);
          setInitError("Error al guardar configuraciÃ³n. Por favor revisa la configuraciÃ³n de tu navegador.");
        }
      }, [messages]);

      const handleDeleteApiKey = useCallback(() => {
        localStorage.removeItem('deepseek-api-key');
        localStorage.removeItem('user-name');
        setApiKey(null);
        setUserName(null);
        setShowApiKeyModal(true);
        setMessages([]);
      }, []);

      const handleSendMessage = useCallback(async (inputText) => {
        if (!inputText.trim() || isLoading || !apiKey) return;
        
        setIsLoading(true);
        const userMessage = { 
          id: generateId(), 
          sender: 'user', 
          text: inputText 
        };
        const botMessage = { 
          id: generateId(), 
          sender: 'bot', 
          text: '', 
          isError: false 
        };
        
        setMessages(prev => [...prev, userMessage, botMessage]);
        
        try {
          const fileContext = uploadedFiles.map(f => `${f.name}:\n${f.content}`).join('\n\n');
          
          const messagesForApi = [
            { role: 'system', content: MASTER_PROMPT },
            ...messages.filter(msg => msg.sender !== 'bot' || msg.text).map(msg => ({
              role: msg.sender === 'user' ? 'user' : 'assistant',
              content: msg.text
            })),
            { role: 'user', content: fileContext ? `${fileContext}\n\n${inputText}` : inputText }
          ];

          const response = await fetch(DEEPSEEK_API_URL, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: DEEPSEEK_MODEL,
              messages: messagesForApi,
              stream: false,
              temperature: 0.7
            })
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error?.message || `La solicitud API fallÃ³ con estado ${response.status}`);
          }

          const data = await response.json();
          const content = data.choices[0]?.message?.content || '';
          
          setMessages(prev => prev.map(msg => 
            msg.id === botMessage.id 
              ? { ...msg, text: content } 
              : msg
          ));

          // Auto-guardar la conversaciÃ³n cuando el bot responde
          saveCurrentConversation();

        } catch (error) {
          console.error('Error de API:', error);
          setMessages(prev => prev.map(msg => 
            msg.id === botMessage.id 
              ? { ...msg, text: `Error: ${error.message}`, isError: true } 
              : msg
          ));
          if (error.message.includes('401')) {
            handleDeleteApiKey();
          }
        } finally {
          setIsLoading(false);
        }
      }, [apiKey, isLoading, messages, uploadedFiles, handleDeleteApiKey]);

      const saveCurrentConversation = useCallback(() => {
        if (messages.length === 0) return;
        
        const newConversation = {
          id: generateId(),
          timestamp: Date.now(),
          messages: [...messages],
          files: [...uploadedFiles]
        };
        
        setConversations(prev => [newConversation, ...prev]);
      }, [messages, uploadedFiles]);

      const loadConversation = useCallback((conversation) => {
        setMessages(conversation.messages);
        setUploadedFiles(conversation.files);
        setShowConversationsModal(false);
      }, []);

      const deleteConversation = useCallback((id) => {
        setConversations(prev => prev.filter(c => c.id !== id));
      }, []);

      const handleDeleteChat = useCallback(() => {
        if (messages.length > 0 && window.confirm("Â¿EstÃ¡s seguro de que quieres eliminar el historial de chat?")) {
          setMessages([]);
          setUploadedFiles([]);
        }
      }, [messages.length]);

      const handleSuggestionClick = useCallback((text) => {
        setInputValue(text);
      }, []);

      if (initError) {
        return (
          <div className="flex items-center justify-center h-screen bg-white dark:bg-gray-900">
            <div className="text-center p-8 max-w-md">
              <h2 className="text-2xl font-bold text-red-500 mb-4">Error de InicializaciÃ³n</h2>
              <p className="text-gray-700 dark:text-gray-300 mb-6">{initError}</p>
              <button
                onClick={() => setShowApiKeyModal(true)}
                className="px-6 py-2 bg-brand-pink text-white rounded-full font-medium hover:opacity-90"
              >
                Ingresar Clave API
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col h-screen max-h-screen bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200">
          {messages.filter(m => m.sender === MessageSender.USER).length === 0 ? (
            <Header onSuggestionClick={handleSuggestionClick} userName={userName} />
          ) : (
            <ChatView messages={messages} />
          )}
          
          <TypingArea
            onSendMessage={handleSendMessage}
            isLoading={isLoading}
            theme={theme}
            toggleTheme={toggleTheme}
            onDeleteChat={handleDeleteChat}
            onOpenUploadModal={() => setFileModalOpen(true)}
            onOpenApiKeyModal={() => setShowApiKeyModal(true)}
            onOpenConversationsModal={() => setShowConversationsModal(true)}
            isApiConfigured={!!apiKey}
            uploadedFilesCount={uploadedFiles.length}
            inputValue={inputValue}
            setInputValue={setInputValue}
          />
            
          {showApiKeyModal && (
            <ApiKeyModal
              onSave={handleSaveApiKey}
              onDelete={handleDeleteApiKey}
              onClose={() => {
                if (apiKey) {
                  setShowApiKeyModal(false);
                }
              }}
              currentKey={apiKey}
            />
          )}
          
          {isFileModalOpen && (
            <FileUploadModal
              uploadedFiles={uploadedFiles}
              setUploadedFiles={setUploadedFiles}
              onClose={() => setFileModalOpen(false)}
            />
          )}

          {showConversationsModal && (
            <ConversationsModal
              conversations={conversations}
              onSelectConversation={loadConversation}
              onDeleteConversation={deleteConversation}
              onClose={() => setShowConversationsModal(false)}
            />
          )}
        </div>
      );
    };

    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
    });

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>
