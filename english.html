<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIBAD - AI Business Assistant powered by DeepSeek</title>
  
  <!-- Preconnect to CDNs for faster loading -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Required Libraries -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/react-markdown@8.0.7/dist/react-markdown.min.js"></script>
  <script src="https://unpkg.com/remark-gfm@3.0.1/dist/remark-gfm.min.js"></script>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  
  <!-- Favicon -->
  <link rel="icon" href="https://bucket.mlcdn.com/a/3336/3336910/images/d7589a2b7ec7033c2395042f615b8c5d96cc06af.png">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'brand-pink': '#DF1783',
          },
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
          }
        }
      }
    }
  </script>
  
  <style>
  .custom-image-widget {
      position: fixed !important;
      top: 50px !important;
      margin: 0 !important;
      padding: 0 !important;
      right: 0px;
      z-index: 999;
    }
    
    .custom-image {
      width: 70px;
      height: auto;
      transition: transform 0.2s;
    }
    
    .custom-image-widget:hover .custom-image {
      transform: scale(1.05);
    }  

    
    body {
      font-family: 'Poppins', sans-serif;
    }
    @keyframes loading-anim {
      0% { background-position: -800px 0; }
      100% { background-position: 800px 0; }
    }
    .loading-bar-anim {
      background: linear-gradient(to right, #DF1783, #e2e8f0, #DF1783);
      background-size: 800px 100%;
      animation: loading-anim 3s linear infinite;
    }
    .dark .loading-bar-anim {
      background: linear-gradient(to right, #DF1783, #1f2937, #DF1783);
      background-size: 800px 100%;
      animation: loading-anim 3s linear infinite;
    }
    .markdown-content {
      line-height: 1.75;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .markdown-content > * + * {
      margin-top: 1.25rem;
    }

    .markdown-content p {
      margin-bottom: 1.25em;
    }
    
    .markdown-content pre {
      position: relative;
      padding-top: 2.5rem;
      margin: 1.5em 0;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
      background: #f8f8f8;
      border-left: 4px solid #DF1783;
    }

    .markdown-content pre:before {
      content: '';
      position: absolute;
      top: 0.75rem;
      left: 1rem;
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      background: #DF1783;
      box-shadow: 1.25rem 0 0 #DF1783, 2.5rem 0 0 #DF1783;
    }

    .dark .markdown-content pre {
      background: #1e293b;
    }
    
    .markdown-content code {
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.9em;
    }
    
    .markdown-content h1, 
    .markdown-content h2, 
    .markdown-content h3, 
    .markdown-content h4 {
      margin-top: 1.5em;
      margin-bottom: 0.75em;
      font-weight: 700;
      color: inherit;
    }
    
    /* Lists */
    .markdown-content ul,
    .markdown-content ol {
      padding-left: 1.5rem;
      margin-bottom: 1em;
    }
    
    .markdown-content li {
      margin-bottom: 0.5em;
    }
    
    .markdown-content blockquote {
      background: rgba(223, 23, 131, 0.05);
      padding: 1rem;
      border-radius: 0.375rem;
      border-left: 4px solid #DF1783;
      padding-left: 1rem;
      margin: 1.5rem 0;
      font-style: italic;
      color: #4b5563;
    }
    
    .dark .markdown-content blockquote {
      color: #9ca3af;
    }
    
    /* Custom bullet points */
    .markdown-content ul {
      list-style-type: none;
      padding-left: 0;
      margin: 1em 0;
    }

    .markdown-content ul li {
      position: relative;
      padding-left: 1.5em;
      margin-bottom: 0.5em;
    }

    .markdown-content ul li:before {
      content: "â€¢";
      color: #DF1783;
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .suggestion-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .emoji {
      font-size: 1.2em;
      margin-right: 4px;
    }

    .suggestion-text {
      margin: 0;
      display: inline;
    }
  </style>
</head>

<body class="font-sans bg-white dark:bg-gray-900 transition-colors duration-300">


   
         <div class="custom-image-widget" style="position: relative; display: inline-block;"> <!-- ADD THESE STYLES -->
    <a href="https://bebell-digital-solutions.github.io/aiba-deepseek/english">
        <img class="custom-image" 
             src="https://bucket.mlcdn.com/a/3336/3336910/images/138f14304ea21715dfae64ae5fe1d71b08c2d451.png" 
             alt="English Translation"
             style="display: block;"> <!-- Ensure image is block-level -->
    </a>

</div>





  
  <div id="root"></div>
  
  <script type="text/babel">
    // Safety checks first
    if (typeof ReactMarkdown === 'undefined') {
      window.ReactMarkdown = ({ children }) => <div>{children}</div>;
      console.warn("ReactMarkdown not loaded - using fallback");
    }
    if (typeof remarkGfm === 'undefined') {
      window.remarkGfm = { default: null };
      console.warn("remarkGfm not loaded - limited markdown features");
    }

    const { useState, useEffect, useRef, useCallback } = React;
    
    // Unique ID generator
    const generateId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;   
    
    // Constants
    const MessageSender = {
      USER: 'user',
      BOT: 'bot',
    };

    const SUGGESTIONS = [
      { text: "ðŸŽ¯ Outline a digital marketing strategy for a new online store", icon: "store" },
      { text: "ðŸŽ¯ What are the key elements of a successful SaaS landing page?", icon: "web" },
      { text: "ðŸŽ¯ Generate 5 content ideas for a content marketing agency", icon: "lightbulb_outline" },
      { text: "ðŸŽ¯ Explain SEO best practices for a small business website in 2025", icon: "trending_up" },
      { text: "ðŸŽ¯ How can I build a Print-On-Demand business in 2025?", icon: "apparel" },
      { text: "ðŸŽ¯ How can I generate additional income with a YouTube channel in 2025?", icon: "youtube_activity" },
      { text: "ðŸŽ¯ Give me 5 business ideas with little or no investment that I can launch in the next 5-10 days", icon: "rocket_launch" },
      { text: "ðŸŽ¯ How can I implement AI technologies in my practice or business?", icon: "network_intel_node" },
    ];

    const MASTER_PROMPT = `You are AIBAD which stands for AI Business Assistant powered by DeepSeek, an expert assistant for online business development.
    Your goal is to provide practical advice, strategies and ideas for entrepreneurs and businesses looking to grow online.
    Your responses should be practical, clear and well-structured using markdown when appropriate. Before doing so, ask conversational questions until you are 95% sure you can provide a valuable response and share professional, actionable recommendations.`;
    
    const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';
    const DEEPSEEK_MODEL = 'deepseek-chat';

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error("Error caught:", error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="flex items-center justify-center h-screen bg-white dark:bg-gray-900">
              <div className="text-center p-8 max-w-md">
                <h2 className="text-2xl font-bold text-red-500 mb-4">Something went wrong</h2>
                <p className="text-gray-700 dark:text-gray-300 mb-6">{this.state.error.message}</p>
                <button
                  onClick={() => window.location.reload()}
                  className="px-6 py-2 bg-brand-pink text-white rounded-full font-medium hover:opacity-90"
                >
                  Reload Page
                </button>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }
    
    // Components
    const BotIcon = () => (
      <svg 
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        className="w-6 h-6 text-brand-pink"
      >
        <path d="M12 8V4H8"/>
        <rect width="16" height="12" x="4" y="8" rx="2"/>
        <path d="M2 14h2"/>
        <path d="M20 14h2"/>
        <path d="M15 13v2"/>
        <path d="M9 13v2"/>
      </svg>
    );

    const UserIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 text-gray-500 dark:text-gray-400">
        <path fillRule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clipRule="evenodd" />
      </svg>
    );

    const LoadingIndicator = () => (
      <div className="flex flex-col gap-2 w-full">
        <div className="loading-bar-anim h-3 rounded-sm w-full"></div>
        <div className="loading-bar-anim h-3 rounded-sm w-4/5"></div>
        <div className="loading-bar-anim h-3 rounded-sm w-3/5"></div>
      </div>
    );
    
    const IconButton = ({ onClick, icon, label, disabled = false, className = '' }) => (
      <button
        type="button"
        onClick={onClick}
        aria-label={label}
        disabled={disabled}
        className={`w-14 h-14 flex-shrink-0 flex items-center justify-center rounded-full bg-slate-100 dark:bg-gray-800 hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-300 disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
      >
        <span className="material-symbols-rounded text-2xl">{icon}</span>
      </button>
    );

    // Simplified ApiKeyModal
    const ApiKeyModal = ({ onSave, onDelete, onClose, currentKey }) => {
      const [key, setKey] = useState(currentKey || '');
      const [error, setError] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!key.trim()) {
          setError('API key is required');
          return;
        }
        onSave(key.trim());
      };

      const handleDelete = () => {
        onDelete();
        setKey('');
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg">
            <header className="p-5 border-b border-slate-200 dark:border-gray-700 flex justify-between items-center">
              <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">DeepSeek API Key Settings</h2>
              {currentKey && (
                <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-gray-700">
                  <span className="material-symbols-rounded text-gray-600 dark:text-gray-300">close</span>
                </button>
              )}
            </header>
            
            <form onSubmit={handleSubmit}>
              <div className="p-6 space-y-4">
                <p className="text-gray-600 dark:text-gray-400"><strong>Note:</strong> Your API key is stored locally in your browser.</p>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">API Key*</label>
                  <input 
                    type="password" 
                    value={key} 
                    onChange={e => {
                      setKey(e.target.value);
                      setError('');
                    }} 
                    placeholder="Paste your API key here" 
                    className="w-full h-12 px-4 rounded-lg bg-slate-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-brand-pink" 
                    required
                  />
                </div>
                
                {error && <p className="mt-2 text-red-500 text-sm">{error}</p>}
                <div className="text-sm text-gray-500 dark:text-gray-400">
                  <a href="https://platform.deepseek.com/api-keys" target="_blank" rel="noopener noreferrer" className="text-brand-pink hover:underline">Get your API key</a>
                </div>
              </div>
              
              <footer className="px-6 py-4 bg-slate-50 dark:bg-gray-800/50 border-t border-slate-200 dark:border-gray-700 flex justify-between items-center">
                {currentKey ? (
                  <button type="button" onClick={handleDelete} className="px-4 py-2 text-sm bg-red-600/10 text-red-600 dark:text-red-400 rounded-full font-semibold hover:bg-red-600/20 transition-colors">Delete Key</button>
                ) : <div></div>}
                <button type="submit" className="px-6 py-2.5 bg-brand-pink text-white rounded-full font-semibold hover:opacity-90 transition-opacity">
                  {currentKey ? 'Save Changes' : 'Save & Start'}
                </button>
              </footer>
            </form>
          </div>
        </div>
      );
    };
    
    // ChatMessage component
    const ChatMessage = ({ message }) => {
      const [copyIcon, setCopyIcon] = useState('content_copy');
      const isBot = message.sender === MessageSender.BOT;
      const isLoading = isBot && message.text === '' && !message.isError;

      const handleCopy = () => {
        if (message.text) {
          navigator.clipboard.writeText(message.text);
          setCopyIcon('done');
          setTimeout(() => setCopyIcon('content_copy'), 1500);
        }
      };

      const cleanText = (text) => {
        return text
          .replace(/^#+\s*/gm, '')    // Remove headings
          .replace(/\*\*/g, '')        // Remove bold
          .replace(/\*/g, '')          // Remove italics and list markers
          .replace(/-\s/g, 'â€¢ ')       // Replace dashes with bullets
          .replace(/^\s*>\s*/gm, '');  // Remove blockquotes
      };

      const messageContentClass = message.isError ? 'text-red-500' : 'text-gray-800 dark:text-gray-200';

      return (
        <div className="group mb-6">
          <div className="flex items-start gap-4 max-w-4xl mx-auto">
            <div className="w-10 h-10 flex-shrink-0 rounded-full flex items-center justify-center bg-slate-100 dark:bg-gray-800">
              {isBot ? <BotIcon /> : <UserIcon />}
            </div>
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                <span className="font-medium text-gray-700 dark:text-gray-300">
                  {isBot ? "AI Assistant" : "You"}
                </span>
              </div>
              
              {isLoading ? (
                <LoadingIndicator />
              ) : (
                <div className={`markdown-content ${messageContentClass}`}>
                  <ReactMarkdown 
                    remarkPlugins={[remarkGfm.default]}
                    components={{
                      h1: ({node, ...props}) => <p className="text-xl font-bold mt-6 mb-3" {...props} />,
                      h2: ({node, ...props}) => <p className="text-lg font-semibold mt-4 mb-2" {...props} />,
                      h3: ({node, ...props}) => <p className="font-medium mt-3 mb-1" {...props} />,
                      p: ({node, ...props}) => <p className="my-3 leading-relaxed" {...props} />,
                      ul: ({node, ...props}) => <ul className="list-disc pl-5 space-y-1 my-3" {...props} />,
                      ol: ({node, ...props}) => <ol className="list-decimal pl-5 space-y-1 my-3" {...props} />,
                      li: ({node, ...props}) => <li className="pl-2" {...props} />,
                      br: ({node, ...props}) => <br {...props} />,
                      hr: ({node, ...props}) => <hr className="my-4 border-t border-gray-200 dark:border-gray-700" {...props} />,
                      a: ({node, ...props}) => <a className="text-brand-pink hover:underline" {...props} />
                    }}
                  >
                    {cleanText(message.text)}
                  </ReactMarkdown>
                </div>
              )}
            </div>
            {isBot && !isLoading && !message.isError && (
              <button 
                onClick={handleCopy} 
                className="opacity-0 group-hover:opacity-100 transition-opacity p-2 rounded-full hover:bg-slate-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400"
              >
                <span className="material-symbols-rounded text-lg">{copyIcon}</span>
              </button>
            )}
          </div>
        </div>
      );
    };

    // ChatView component
    const ChatView = ({ messages }) => {
      const chatEndRef = useRef(null);
      
      useEffect(() => {
        chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      return (
        <div className="flex-1 overflow-y-auto px-4 pt-4 pb-36 sm:pb-32">
          <div className="max-w-4xl mx-auto">
            {messages.map(msg => <ChatMessage key={msg.id} message={msg} />)}
            <div ref={chatEndRef} />
          </div>
        </div>
      );
    };

    // SuggestionCard component
    const SuggestionCard = ({ text, icon, onClick }) => (
      <div onClick={onClick} className="group cursor-pointer p-5 flex-shrink-0 w-56 h-56 flex flex-col justify-between rounded-2xl bg-slate-100 dark:bg-gray-800 hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors duration-200">
        <h4 className="text-base font-medium text-gray-800 dark:text-gray-200">{text}</h4>
        <div className="self-end w-11 h-11 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-300 via-gray-200 to-gray-400 shadow-[inset_0_2px_4px_rgba(255,255,255,0.7),inset_0_-2px_4px_rgba(0,0,0,0.1)] dark:bg-gradient-to-br dark:from-gray-600 dark:via-gray-700 dark:to-gray-800 dark:shadow-[inset_0_2px_4px_rgba(0,0,0,0.3),inset_0_-2px_4px_rgba(255,255,255,0.1)] transition-all duration-300 group-hover:bg-gradient-to-tr group-hover:from-[#df1783] group-hover:to-[#fd5d93] group-hover:shadow-none">
          <span className="material-symbols-rounded text-2xl text-transparent bg-clip-text bg-gradient-to-br from-gray-600 to-gray-800 dark:from-gray-200 dark:to-gray-400 group-hover:text-white group-hover:bg-none">
            {icon}
          </span>
        </div>
      </div>
    );

    // Header component
    const Header = ({ onSuggestionClick }) => {
      return (
        <header className={'flex-1 overflow-y-auto px-4 pt-16 pb-8 sm:pt-24 lg:pt-28'}>
          <div className="max-w-4xl mx-auto">
            <div>
              <h1 className="text-5xl sm:text-6xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-brand-pink to-purple-500">
                Hello
              </h1>
              <p className="text-4xl sm:text-5xl font-medium text-gray-400 dark:text-gray-500 mt-2">How can I help you today?</p>
            </div>
            <div className="mt-16 sm:mt-24">
              <div className="flex gap-5 pb-4 -mx-4 px-4 overflow-x-auto">
                {SUGGESTIONS.map((s, i) => (
                  <SuggestionCard 
                    key={i} 
                    text={s.text} 
                    icon={s.icon} 
                    onClick={() => onSuggestionClick(s.text)} 
                  />
                ))}
              </div>
            </div>
          </div>
        </header>
      );
    };

    // TypingArea component - simplified
    const TypingArea = ({ onSendMessage, isLoading, theme, toggleTheme, onDeleteChat, onOpenApiKeyModal, isApiConfigured, inputValue, setInputValue }) => {
      const handleSubmit = (e) => {
        e.preventDefault();
        if (inputValue.trim() && isApiConfigured) {
          onSendMessage(inputValue);
          setInputValue('');
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          handleSubmit(e);
        }
      };

      return (
        <div className="fixed bottom-0 left-0 w-full bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg border-t border-slate-200 dark:border-gray-700">
          <div className="max-w-4xl mx-auto px-4 pt-2 pb-4 sm:pb-4">
            <div className="flex items-center gap-3">
              <IconButton 
                onClick={onOpenApiKeyModal} 
                icon="key" 
                label="Manage API key" 
                className="hidden sm:flex" 
              />
              
              <form onSubmit={handleSubmit} className="flex-1 relative">
                <textarea
                  value={inputValue}
                  onChange={e => setInputValue(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder={isApiConfigured ? "Type your message here..." : "Please configure your API key to get started."}
                  required
                  disabled={isLoading || !isApiConfigured}
                  className="w-full h-14 min-h-[56px] max-h-32 pl-6 pr-16 py-4 rounded-full bg-slate-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-pink transition disabled:opacity-70 disabled:cursor-not-allowed resize-none flex items-center"
                  rows={1}
                  style={{ lineHeight: '24px' }}
                />
                
                <button
                  type="submit"
                  disabled={isLoading || !isApiConfigured || !inputValue.trim()}
                  className={`absolute right-0 top-0 h-14 w-14 flex items-center justify-center text-white rounded-full transition-transform transform ${inputValue.trim() && isApiConfigured ? 'scale-100' : 'scale-0'} ${isLoading ? 'bg-gray-500' : 'bg-brand-pink'} disabled:bg-gray-500`}
                  aria-label="Send Message"
                >
                  <span className="material-symbols-rounded">send</span>
                </button>
              </form>
              
              <div className="hidden sm:flex items-center gap-3">
                <IconButton 
                  onClick={toggleTheme} 
                  icon={theme === 'dark' ? 'light_mode' : 'dark_mode'} 
                  label="Toggle theme" 
                />
                <IconButton 
                  onClick={onDeleteChat} 
                  icon="delete" 
                  label="Clear chat" 
                  disabled={isLoading || !isApiConfigured} 
                />
              </div>
              
              <div className="sm:hidden flex">
                <IconButton 
                  onClick={onOpenApiKeyModal} 
                  icon="key" 
                  label="Manage API key" 
                />
              </div>
            </div>
            <p className="hidden sm:block text-center text-xs text-gray-400 dark:text-gray-500 mt-3 px-4">
              AIBAD may display inaccurate information. Always verify its responses.
            </p>
          </div>
        </div>
      );
    };

    // Main App Component - simplified
    const App = () => {
      const [theme, setTheme] = useState(() => {
        const savedTheme = localStorage.getItem("aibad-theme");
        return savedTheme === 'light' || savedTheme === 'dark' 
          ? savedTheme 
          : window.matchMedia?.('(prefers-color-scheme: dark)').matches 
            ? 'dark' 
            : 'light';
      });
      
      const [messages, setMessages] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('deepseek-api-key') || null);
      const [initError, setInitError] = useState(null);
      const [inputValue, setInputValue] = useState('');

      useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('aibad-theme', theme);
      }, [theme]);

      const toggleTheme = useCallback(() => {
        setTheme(prev => prev === 'dark' ? 'light' : 'dark');
      }, []);

      const handleSaveApiKey = useCallback((key) => {
        try {
          localStorage.setItem('deepseek-api-key', key);
          setApiKey(key);
          setShowApiKeyModal(false);
          setInitError(null);
          
          if (messages.length === 0) {
            setMessages([{
              id: 'bot-welcome',
              sender: 'bot',
              text: "Hello! I'm AIBAD, your AI Business Assistant. How can I help you today?",
              isError: false
            }]);
          }
        } catch (e) {
          console.error("Error saving settings:", e);
          setInitError("Error saving settings. Please check your browser configuration.");
        }
      }, [messages]);

      const handleDeleteApiKey = useCallback(() => {
        localStorage.removeItem('deepseek-api-key');
        setApiKey(null);
        setShowApiKeyModal(true);
        setMessages([]);
      }, []);

      const handleSendMessage = useCallback(async (inputText) => {
        if (!inputText.trim() || isLoading || !apiKey) return;
        
        setIsLoading(true);
        const userMessage = { 
          id: generateId(), 
          sender: 'user', 
          text: inputText 
        };
        const botMessage = { 
          id: generateId(), 
          sender: 'bot', 
          text: '', 
          isError: false 
        };
        
        setMessages(prev => [...prev, userMessage, botMessage]);
        
        try {
          const messagesForApi = [
            { role: 'system', content: MASTER_PROMPT },
            ...messages.filter(msg => msg.sender !== 'bot' || msg.text).map(msg => ({
              role: msg.sender === 'user' ? 'user' : 'assistant',
              content: msg.text
            })),
            { role: 'user', content: inputText }
          ];

          const response = await fetch(DEEPSEEK_API_URL, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: DEEPSEEK_MODEL,
              messages: messagesForApi,
              stream: false,
              temperature: 0.7
            })
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error?.message || `API request failed with status ${response.status}`);
          }

          const data = await response.json();
          const content = data.choices[0]?.message?.content || '';
          
          setMessages(prev => prev.map(msg => 
            msg.id === botMessage.id 
              ? { ...msg, text: content } 
              : msg
          ));

        } catch (error) {
          console.error('API Error:', error);
          setMessages(prev => prev.map(msg => 
            msg.id === botMessage.id 
              ? { ...msg, text: `Error: ${error.message}`, isError: true } 
              : msg
          ));
          if (error.message.includes('401')) {
            handleDeleteApiKey();
          }
        } finally {
          setIsLoading(false);
        }
      }, [apiKey, isLoading, messages, handleDeleteApiKey]);

      const handleDeleteChat = useCallback(() => {
        if (messages.length > 0 && window.confirm("Are you sure you want to clear the chat history?")) {
          setMessages([]);
        }
      }, [messages.length]);

      const handleSuggestionClick = useCallback((text) => {
        setInputValue(text);
      }, []);

      const [showApiKeyModal, setShowApiKeyModal] = useState(!apiKey);

      if (initError) {
        return (
          <div className="flex items-center justify-center h-screen bg-white dark:bg-gray-900">
            <div className="text-center p-8 max-w-md">
              <h2 className="text-2xl font-bold text-red-500 mb-4">Initialization Error</h2>
              <p className="text-gray-700 dark:text-gray-300 mb-6">{initError}</p>
              <button
                onClick={() => setShowApiKeyModal(true)}
                className="px-6 py-2 bg-brand-pink text-white rounded-full font-medium hover:opacity-90"
              >
                Enter API Key
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col h-screen max-h-screen bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200">
          {messages.filter(m => m.sender === MessageSender.USER).length === 0 ? (
            <Header onSuggestionClick={handleSuggestionClick} />
          ) : (
            <ChatView messages={messages} />
          )}
          
          <TypingArea
            onSendMessage={handleSendMessage}
            isLoading={isLoading}
            theme={theme}
            toggleTheme={toggleTheme}
            onDeleteChat={handleDeleteChat}
            onOpenApiKeyModal={() => setShowApiKeyModal(true)}
            isApiConfigured={!!apiKey}
            inputValue={inputValue}
            setInputValue={setInputValue}
          />
            
          {showApiKeyModal && (
            <ApiKeyModal
              onSave={handleSaveApiKey}
              onDelete={handleDeleteApiKey}
              onClose={() => {
                if (apiKey) {
                  setShowApiKeyModal(false);
                }
              }}
              currentKey={apiKey}
            />
          )}
        </div>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>
